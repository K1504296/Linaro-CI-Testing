- job:
    name: tcwg-buildslave-command
    project-type: matrix
    defaults: global
    logrotate:
        daysToKeep: 30
        numToKeep: 30
    properties:
        - authorization:
            anonymous:
                - job-read
                - job-extended-read
            linaro:
                - job-build
                - job-cancel
    parameters:
        - string:
            name: machines_list
            default: 'dev-01.tcwglab'
            description: 'Machines to run on: tcwg-aarch64-07 tcwg-aarch64-build-01 tcwg-aarch64-build-02 tcwg-aarch64-test-01 tcwg-aarch64-test-02 tcwg-x86_64-build-01 tcwg-x86_64-build-02 tcwg-x86_64-build-03 tcwg-x86_64-build-04 tcwg-x86_64-build-05 tcwg-x86_64-build-06 tcwg-x86_64-build-07 tcwg-x86_64-build-08 tcwg-x86_64-dev-01 tcwg-x86_64-dev-02 tcwg-x86_64-ex40build-01 docker-trusty-amd64-tcwg docker-trusty-i386-tcwg docker-trusty-arm64-tcwg docker-trusty-armhf-tcwg docker-trusty-arm64-tcwg-test docker-trusty-armhf-tcwg-test'
        - string:
            name: command
            default: 'ls $HOME/*'
            description: 'Command to run'
        - bool:
            name: dry_run
            default: 'false'
            description: 'Whether to do a dry-run'
    disabled: false
    node: tcwg-x86_64-dev-01
    concurrent: true
    display-name: 'TCWG CCC Buildslave command'
    axes:
        - axis:
            type: dynamic
            name: machine
            values:
                - machines_list
            description: 'SSH names of machines to run the command on'
        - axis:
            type: slave
            name: label
            values:
                - tcwg-x86_64-dev-01
    wrappers:
        - timeout:
            timeout: 60
        - timestamps
        - ssh-agent-credentials:
            # tcwg-buildslave user id
            users:
                - 'e0958a95-204f-4c14-a66c-5e2be6c5d50a'
        - build-name:
            name: '#${BUILD_NUMBER}-${ENV,var="machines_list"}'
    builders:
        - shell: |
            #!/bin/bash

            set -ex

            cat > command.sh.$$$$ << EOF
            #!/bin/bash

            set -ex

            $command
            EOF
            chmod +x command.sh.$$$$

            cat command.sh.$$$$

            scp command.sh.$$$$ $machine:/tmp/
            # Don't use ssh shared connection to reliably proxy SSH agent
            $dry_run || ssh -Snone $machine /tmp/command.sh.$$$$
