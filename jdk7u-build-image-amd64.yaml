- job:
    name: jdk7u-build-image-amd64
    project-type: freestyle
    defaults: global
    description: |
        * Builds the jdk7 images.
    properties:
        - authorization:
            anonymous:
                - job-read
                - job-extended-read
            linaro:
                - job-build
                - job-cancel
        - build-discarder:
            days-to-keep: 10
            artifact-num-to-keep: 1
    parameters:
        - string:
            name: JVM_VARIANT
            default: client
        - string:
            name: BUILD_TYPE
            default: release
    disabled: false
    node: docker-utopic-amd64
    display-name: 'OpenJDK - Build OpenJDK 7 images'
    wrappers:
        - timestamps
    builders:
        - copyartifact:
            project: jdk7u-update-src-tree
            filter: 'out/jdk7u.tar.gz'
            target: incoming
            flatten: true
        - copyartifact:
            project: archive-primordial-jdk7-amd64
            filter: 'out/primordial-jdk7.tar.gz'
            target: incoming
            flatten: true
        - shell: |
            #!/bin/bash

            set -exu

            sudo sed -i \
              -e 's/archive.ubuntu.com\|security.ubuntu.com/old-releases.ubuntu.com/g' \
              -e 's/^.*arm64.*$//g' \
              /etc/apt/sources.list
            sudo apt-get update
            sudo apt-get install -y --no-install-recommends \
              ant gawk libasound2-dev libcups2-dev libfreetype6-dev libxext-dev \
              libxrender-dev libxt-dev libxtst-dev unzip zip

            rm -rf jdk7u primordial-jdk7
            tar xf incoming/jdk7u.tar.gz
            tar xf incoming/primordial-jdk7.tar.gz
            pushd jdk7u
            export LANG=C
            make ALT_BOOTDIR=${WORKSPACE}/primordial-jdk7 BUILD_NUMBER=b${BUILD_NUMBER}
            popd

            # Archive the result
            rm -rf out
            mkdir out
            artifact_name=jdk7u-${JVM_VARIANT}-${BUILD_TYPE}
            tar -C jdk7u/build/linux-amd64/j2sdk-image --exclude=\*.diz --transform="s#^#${artifact_name}/#" -acf out/${artifact_name}.tar.gz jre bin lib
    publishers:
        - archive:
            artifacts: 'out/*.tar.gz'
