- job:
    name: tcwg-abe-test-container
    project-type: freestyle
    defaults: global
    logrotate:
        daysToKeep: 30
        numToKeep: 30
    properties:
        - authorization:
            anonymous:
                - job-read
                - job-extended-read
            linaro:
                - job-build
                - job-cancel
    parameters:
        - string:
            name: user
            default: tcwg-buildslave
            description: 'Non-root user inside container'
        - string:
            name: public_key
            default: ldap
            description: 'SSH public key to install for $user and root'
    disabled: false
    node: docker-trusty-i386-tcwg
    concurrent: true
    display-name: 'TCWG ZZZ ABE Test Container'
    wrappers:
        - timeout:
            timeout: 600
        - timestamps
        - ssh-agent-credentials:
            # tcwg-buildslave user id
            users:
                - 'e0958a95-204f-4c14-a66c-5e2be6c5d50a'
        - build-name:
            name: '#${BUILD_NUMBER}'
    builders:
        - shell: |
            #!/bin/bash

            set -ex

            env > abe-test-container.log

            if [ x"$public_key" = x"ldap" ]; then
              public_key="$(ssh people.linaro.org sss_ssh_authorizedkeys $user)"
            fi

            if ! getent passwd $user; then
              user_data="$(ssh people.linaro.org getent passwd $user)"
              user_uid="$(echo "$user_data" | cut -d: -f 3)"
              if [ x"$user_uid" != x"" ]; then
                user_uid_opt="-u $user_uid"
              fi

              sudo useradd -m $user_uid_opt $user
            fi

            echo "$public_key" >> ~/.ssh/authrized_keys
            sudo rsync -a ~/.ssh/ /home/$user/.ssh/
            sudo chown -R $user /home/$user/.ssh/

            sudo touch /keep-container
            sudo chmod 0777 /keep-container
            echo "1" > /keep-container
        - trigger-builds:
            - project: 'tcwg-abe-test-container-wait'
              same-node: true
    publishers:
        - archive:
            artifacts: 'abe-test-container.log'
            latest-only: false
