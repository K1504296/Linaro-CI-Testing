- scm:
    name: llvm
    scm:
        - git:
            url: https://git-us.linaro.org/toolchain/llvm/llvm
            branches:
                - refs/heads/master
            basedir: llvm
            skip-tag: true
            shallow-clone: false
            reference-repo: /home/tcwg-buildslave/llvm-reference/llvm
            wipe-workspace: false
            clean:
                before: true
- scm:
    name: clang
    scm:
        - git:
            url: https://git-us.linaro.org/toolchain/llvm/clang
            branches:
                - refs/heads/master
            basedir: llvm/tools/clang
            skip-tag: true
            shallow-clone: false
            reference-repo: /home/tcwg-buildslave/llvm-reference/clang
            wipe-workspace: false
            clean:
                before: true
- scm:
    name: linux
    scm:
        - git:
            url: https://git-us.linaro.org/people/maxim.kuvyrkov/linux2
            branches:
                - refs/heads/master
            basedir: linux
            skip-tag: true
            shallow-clone: false
            reference-repo: /home/tcwg-buildslave/snapshots-ref/linux.git
            wipe-workspace: false
            clean:
                before: true
- job:
    name: tcwg-trigger-llvm-kernel-aarch64
    project-type: freestyle
    defaults: global
    properties:
        - authorization:
            anonymous:
                - job-read
                - job-extended-read
            linaro:
                - job-build
                - job-cancel
        - build-discarder:
            days-to-keep: 30
            num-to-keep: 30
    disabled: false
    node: tcwg-coordinator
    concurrent: false
    display-name: 'TCWG Trigger LLVM + Linux-next @ AArch64'
    scm:
        - llvm
        - clang
        - linux
    triggers:
        # Every 5min
        - pollscm:
            cron: '*/5 * * * *'
    wrappers:
        - timeout:
            timeout: 600
        - timestamps
        - ssh-agent-credentials:
            # tcwg-buildslave user id
            users:
                - 'e0958a95-204f-4c14-a66c-5e2be6c5d50a'
    builders:
        - shell: |
            #!/bin/bash
            set -e
            echo "=== Print out environment for debug purposes ==="
            env | grep "GIT"
            echo "=== Environment end  ==="
            set -x
            rm -f trigger-*
            for url in $GIT_URL $GIT_URL_1 $GIT_URL_2; do
              case "$(basename $url)" in
                llvm) dir=llvm ;;
                clang) dir=llvm/tools/clang ;;
                linux*) dir=linux ;;
              esac
              if [ x"$(git -C $dir branch --list --remotes --contains HEAD origin/linaro-local/ci/llvm-kernel-aarch64-tested)" != x"" ]; then
                continue
              fi
              project=$(basename $dir)
              echo "current_project=$project" > trigger-$project
            done
            echo "Going to trigger:"
            find -name "trigger-*"
        - trigger-builds:
            - project: tcwg-rr-llvm-kernel-aarch64
              parameter-factories:
                - factory: filebuild
                  file-pattern: trigger-*
