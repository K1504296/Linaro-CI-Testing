- job:
    name: tcwg-publish-snapshot
    project-type: freestyle
    defaults: global
    properties:
        - authorization:
            anonymous:
                - job-read
                - job-extended-read
            linaro:
                - job-build
                - job-cancel
        - build-discarder:
            days-to-keep: 30
            num-to-keep: 30
    parameters:
        - string:
                name: snapshot_version
                default: ''
                description: 'Snapshot revision to deploy (like: 5.2-2015.10, 5.2-2015.11-rc1)'
        - bool:
               name: binaries
               default: false
               description: 'Publish binaries'
        - string:
                name: notes_branch
                default: 'toolchain-snapshots'
                description: 'Release notes branch name or sha1, e.g., releases/linaro-6.2-2016.11-rc2'
        - bool:
               name: notes_only
               default: false
               description: 'Publish release notes only'
    disabled: false
    node: tcwg-x86_64-dev-01
    display-name: 'TCWG source or binaries tarball publishing on snapshot.linaro.org'
    wrappers:
        - timestamps
    builders:
        - linaro-publish-token
        - shell: |
            #!/bin/bash

            set -ex

            trap cleanup_exit INT TERM EXIT

            cleanup_exit()
            {
              cd ${WORKSPACE}
              rm -rf out
            }

            # Extract GCC version, and other needed mangling information
            # Since GCC 5 our branch name only contains GCC major number.
            gcc_version=${snapshot_version%%-*}
            gcc_major=${gcc_version%%.*}
            version_suffix=${snapshot_version##*-}
            bin_dir=${gcc_major}-${snapshot_version#*-}
            dest_dir="components/toolchain/"

            if [[ "$version_suffix" != rc* ]]; then
              prefix="snapshot"
              bin_dir="snapshot-$bin_dir"
            else
              prefix="$version_suffix"
            fi

            [ $gcc_major -ge "5" ] && gcc_version=$gcc_major

            if ${binaries}; then
              dest_dir+="binaries"
              notes_path="/${dest_dir}"
              cp_content="-r $HOME/releases/binaries/${bin_dir}/*"
            else
              dest_dir+="gcc-linaro"
              notes_path="/${dest_dir}/${gcc_version}"
              cp_content="-r $HOME/releases/sources/${prefix}-${snapshot_version}/*"
            fi

            mkdir -p out

            # Release notes
            notes_url=https://git.linaro.org/toolchain/release-notes.git/plain/
            wget ${notes_url}${notes_path}/README.textile?h=${notes_branch} -O out/README.textile

            if ! ${notes_only}; then
              cp ${cp_content} out/
            fi

            # Publish to snapshots
            test -d ${HOME}/bin || mkdir ${HOME}/bin
            wget https://git.linaro.org/ci/publishing-api.git/plain/linaro-cp.py -O ${HOME}/bin/linaro-cp.py
            time python ${HOME}/bin/linaro-cp.py \
              --api_version 3 \
              out ${dest_dir}/${snapshot_version}/
    publishers:
        - email-ext:
            recipients: 'bernhard.rosenkranzer@linaro.org, fathi.boudra@linaro.org, koen.kooi@linaro.org'
            always: true
