- job:
    name: bd-kibana-deb
    project-type: freestyle
    defaults: global
    logrotate:
        daysToKeep: 30
        numToKeep: 30
        artifactNumToKeep: 1
    properties:
        - authorization:
            anonymous:
                - job-read
                - job-extended-read
            linaro:
                - job-read
                - job-extended-read
                - job-build
                - job-cancel
    parameters:
    disabled: false
    node: docker-jessie-arm64
    display-name: 'Kibana (deb)'
    wrappers:
        - timestamps
    builders:
        - shell: |
            #!/bin/bash

            set -ex
            # setup environments
            export LANG="en_US.UTF-8"

            # install prerequisites
            sudo apt-get update -y
            sudo apt-get install -y git build-essential automake autoconf libtool
            sudo apt-get install -y libffi-dev ruby-dev rubygems python2.7
            sudo apt-get install -y curl zip rpm
            sudo gem install fpm -v 1.5.0
            sudo gem install pleaserun -v 0.0.24
            sudo ln -s /usr/bin/python2.7 /usr/bin/python

            curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.2/install.sh | bash
            source ${HOME}/.bashrc

            # clone the Kibana definitions
            git clone --depth 1 https://git.linaro.org/leg/bigdata/kibana.git -b v5.4.1 ${WORKSPACE}/kibana
            cd ${WORKSPACE}/kibana

            # Install the version of node.js listed in the .node-version file (this can be easily automated with tools such as nvm and avn)
            nvm install "$(cat .node-version)"

            # Install npm dependencies
            npm install
            npm rebuild node-sass

            npm run build -- --deb --release

    publishers:
        - archive:
            artifacts: 'kibana/output/**'
        - email-ext:
            recipients: 'leg-bigdata@linaro.org, fathi.boudra@linaro.org'
