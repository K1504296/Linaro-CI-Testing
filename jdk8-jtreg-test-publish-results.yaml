- job:
    name: jdk8-jtreg-test-publish-results
    project-type: freestyle
    defaults: global
    description: |
        * Results are published to http://openjdk.linaro.org/openjdk8-jtreg-nightly-tests/
    properties:
        - authorization:
            anonymous:
                - job-read
                - job-extended-read
            openjdk-members:
                - job-build
                - job-cancel
        - build-discarder:
            days-to-keep: 30
            num-to-keep: 10
            artifact-num-to-keep: 5
    parameters:
        - string:
            name: PUBLISH_DEST
            default: ''
        - string:
            name: PUBLISH_HOST
            default: ''
    disabled: false
    node: aarch64-06
    display-name: 'OpenJDK 8 - Publish jtreg results'
    wrappers:
        - timestamps
        - ssh-agent-credentials:
            # openjdk-testing user id
            users:
                - '744cffb4-9ce1-4856-b103-9fdda06dad36'
        - credentials-binding:
            - text:
                credential-id: OPENJDK_KEY
                variable: PRIVATE_KEY
    builders:
        - copyartifact:
            project: jtreg-build
            filter: 'jtreg-build-4.2.0-SNAPSHOT.tar.xz'
            flatten: true
        - shell: |
            #!/bin/bash

            set -ex

            # Start ssh-agent workaround
            trap cleanup_exit INT TERM EXIT

            cleanup_exit()
            {
                kill -9 ${SSH_AGENT_PID}
            }

            TMPKEYDIR=$(mktemp -d /tmp/sct.XXXXXX)
            cat > ${TMPKEYDIR}/private-key-wrapper.py << EOF
            #!/usr/bin/python

            import os
            import sys

            def main():
                private_key = os.environ.get("PRIVATE_KEY", "Undefined")
                if private_key == "Undefined":
                    sys.exit("PRIVATE_KEY is not defined.")

                buffer = private_key.replace(' ','\n')
                with open('linaro-private-key', 'w') as f:
                    f.write('-----BEGIN RSA PRIVATE KEY-----\n')
                    f.write(buffer)
                    f.write('\n-----END RSA PRIVATE KEY-----\n')

            if __name__ == "__main__":
                main()
            EOF
            python ${TMPKEYDIR}/private-key-wrapper.py
            chmod 0600 ${WORKSPACE}/linaro-private-key

            eval `ssh-agent` >/dev/null 2>/dev/null
            ssh-add ${WORKSPACE}/linaro-private-key >/dev/null 2>/dev/null
            rm -rf ${WORKSPACE}/linaro-private-key ${TMPKEYDIR}

            test -d ~/.ssh || mkdir ~/.ssh
            ssh-keyscan people.linaro.org >> ~/.ssh/known_hosts
            LANG=C sort -u ~/.ssh/known_hosts | sponge ~/.ssh/known_hosts
            cat << EOF >> ~/.ssh/config
            Host people.linaro.org
                User stuart.monteith
            EOF
            chmod 0600 ~/.ssh/*

            # End workload

            PERSIST=$HOME/srv/openjdk
            SCRIPT_DIR=$PERSIST/openjdk-test-scripts

            tree $PERSIST | xz >$WORKSPACE/tree.out.xz

            if [ -d $SCRIPT_DIR ]; then
                (cd $SCRIPT_DIR; git pull)
            else
                git clone https://git.linaro.org/leg/openjdk/openjdk-test-scripts.git $SCRIPT_DIR
            fi

            tar xf jtreg-build-4.2.0-SNAPSHOT.tar.xz
            export PATH=${WORKSPACE}/jtreg/bin:$PATH
            which jtdiff
            TOP_DIR=$PERSIST/openjdk8-jtreg-nightly-tests bash -x $SCRIPT_DIR/publish $PUBLISH_DEST $NODE_NAME
    publishers:
        - archive:
            artifacts: 'tree.out.xz'
        - email:
            recipients: 'fathi.boudra@linaro.org stuart.monteith@linaro.org'
