- job:
    name: lkft-staging-no-skiplist.yaml
    project-type: matrix
    defaults: global
    properties:
        - authorization:
            anonymous:
                - job-read
                - job-extended-read
                - job-workspace
            linaro:
                - job-read
                - job-extended-read
                - job-build
                - job-cancel
        - build-discarder:
            days-to-keep: 30
            num-to-keep: 30
            artifact-num-to-keep: 1
    disabled: true
    node: master
    display-name: 'LKFT - Staging no skip list'
    triggers:
        # trigger every Saturday
        - timed: 'H 0 * * 6'
    axes:
        - axis:
            type: user-defined
            name: BUILD_NAME
            values:
                - 'linux-next'
                - 'linux-mainline'
                - 'linux-stable-4.4'
                - 'linux-stable-4.9'
                - 'linux-stable-4.14'
        - axis:
            type: user-defined
            name: QA_SERVER
            values:
                - 'https://qa-reports.linaro.org'
        - axis:
            type: user-defined
            name: DEVICE_TYPE
            values:
                - 'hi6220-hikey'
                - 'x86'
                - 'juno-r2'
                - 'x15'
    execution-strategy:
        sequential: false
    wrappers:
        - timestamps
        - ssh-agent-credentials:
            users:
                - 'OE_COMMIT_BOT_KEY'
        - credentials-binding:
            - text:
                credential-id: QA_REPORTS_TOKEN
                variable: QA_REPORTS_TOKEN
    builders:
        - shell: |
            #!/bin/bash
            export LAVA_SERVER=https://lkft.validation.linaro.org/RPC2/

            # set kselftest and ltp skiplist depending on the kernel used
            # set proper variables depending on the kernel used
            export KSELFTESTS_SKIPLIST="breakpoint_test breakpoint_test_arm64 step_after_suspend_test ftracetest"
            export LTP_SKIPLIST="skiplist-lkft-minimal"
            case ${DEVICE_TYPE} in
              hi6220-hikey)
                MACHINE=hikey
                ;;
              juno-r2)
                MACHINE=juno
                ;;
              x15)
                MACHINE=am57xx-evm
                ;;
              x86)
                MACHINE=intel-core2-32
                export LTP_SKIPLIST="skiplist-lkft-nfs-minimal"
                ;;
              *)
                ;;
            esac
            export DISTRO=rpb
            export MANIFEST_BRANCH=morty
            export SNAPSHOTS_URL=https://snapshots.linaro.org
            export BASE_URL=openembedded/lkft/${MANIFEST_BRANCH}/${MACHINE}/${DISTRO}/${PUB_DEST}/latest

            export SNAPSHOTS_BASE_URL=${SNAPSHOTS_URL}/${BASE_URL}

            # retrieve build specific details
            MD5_FILENAME="MD5SUMS.txt"
            BUILD_CONFIG="build_config.json"
            wget -O "${MD5_FILENAME}" "${SNAPSHOTS_BASE_URL}/${MD5_FILENAME}"
            wget -O "${BUILD_CONFIG}" "${SNAPSHOTS_BASE_URL}/${BUILD_CONFIG}"
            rm build_env.sh
            for ENVVAR in $(jq --raw-output 'to_entries[] | "\(.key | ascii_upcase)=\(.value | sub("[[:space:]]+"; "_"))"' < build_config.json)
            do
                echo ${ENVVAR} >> build_env.sh
            done
            . ./build_env.sh
            ROOTFS_FILENAME=$(grep -E "rpb-console-image-${MACHINE}-[0-9]{14}-[0-9]+\.rootfs\.img\.gz" "${MD5_FILENAME}" | awk '{print $2}')
            NFS_FILENAME=$(grep -E "rpb-console-image-${MACHINE}-[0-9]{14}-[0-9]+\.rootfs\.tar\.xz" "${MD5_FILENAME}" | awk '{print $2}')
            BOOT_FILENAME=$(grep -E "boot\S*uefi\.img" "${MD5_FILENAME}" | awk '{print $2}')
            KERNEL_FILENAME=$(grep -E "bzImage" "${MD5_FILENAME}" | awk '{print $2}')
            export KERNEL_URL="${BUILD_LOCATION}/${KERNEL_FILENAME}"
            export NFSROOTFS_URL="${BUILD_LOCATION}/${NFS_FILENAME}"
            export BOOT_URL="${BUILD_LOCATION}/${BOOT_FILENAME}"
            export SYSTEM_URL="${BUILD_LOCATION}/${ROOTFS_FILENAME}"
            export KERNEL_COMMIT=${KERNEL_COMMIT_ID}
            export LAVA_JOB_PRIORITY=low
            export KERNEL_CONFIG_URL=${BUILD_LOCATION}/config
            export KERNEL_VERSION=${MAKE_KERNELVERSION}
            rm build_env.sh
            rm ${MD5_FILENAME}
            rm ${BUILD_CONFIG}
            export LAVA_JOB_PRIORITY="low"

            rm -rf configs
            git clone --depth 1 http://git.linaro.org/ci/job/configs.git

            for test in $(ls configs/openembedded-lkft/lava-job-definitions/testplan); do
                TEST_TEMPLATES="${TEST_TEMPLATES} testplan/${test}"
            done
            if [ ! -z "${KERNEL_DESCRIBE}" ]; then
                export QA_BUILD_VERSION=${KERNEL_DESCRIBE}
            else
                export QA_BUILD_VERSION=${KERNEL_COMMIT:0:12}
            fi

            python configs/openembedded-lkft/submit_for_testing.py \
              --device-type ${DEVICE_TYPE} \
              --build-number ${BUILD_NUMBER} \
              --lava-server ${LAVA_SERVER} \
              --qa-server ${QA_SERVER} \
              --qa-server-team staging-lkft \
              --qa-server-project ${BUILD_NAME} \
              --git-commit ${QA_BUILD_VERSION} \
              --test-plan ${TEST_TEMPLATES}
    publishers:
        - groovy-postbuild:
            script:
                !include-raw: openembedded-lkft/postbuild.groovy
        - email-ext:
            recipients: 'lkft-triage@lists.linaro.org'
            matrix-trigger: only-configurations
            subject: '[CI] ${BUILD_NAME}: ${DEVICE_TYPE} - ${BUILD_STATUS}'
