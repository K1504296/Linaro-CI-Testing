- job:
    name: robher-aosp-gendev
    project-type: matrix
    defaults: global
    properties:
        - authorization:
            anonymous:
                - job-read
            vishal.bhoj@linaro.org:
                - job-build
                - job-read
                - job-extended-read
                - job-configure
                - job-cancel
            rob.herring@linaro.org:
                - job-build
                - job-read
                - job-extended-read
                - job-configure
                - job-cancel
        - build-discarder:
            days-to-keep: 60
            num-to-keep: 60
    disabled: false
    display-name: 'AOSP Generic Device build by Rob Herring'
    triggers:
        - timed: 'H H * * *'
    axes:
        - axis:
            type: slave
            name: label
            values:
                - docker-xenial-aosp
        - axis:
            type: user-defined
            name: ARCH
            values:
                - arm
                - arm64
                - arm64_only
                - x86_64
    execution-strategy:
        sequential: true
    wrappers:
        - timestamps
        - timeout:
            timeout: 500
    builders:
        - linaro-publish-token:
            host: snapshots.linaro.org
        - shell:
            !include-raw: android-lcr/common/builders.sh
        - shell: |
            #!/bin/bash

            set -ex

            # Clean any artifacts related to previous build
            rm -rf out/target/product/*/system/ out/target/product/*/data/ out/target/product/*/*.xml out/target/product/*/obj/kernel/
            rm -rf out/target/product/*/*.zip out/target/product/*/*.img out/target/product/*/*.xz

            # Runs as ubuntu
            repo init -u https://android.googlesource.com/platform/manifest -b master
            cd .repo
            rm -rf local_manifests
            git clone https://github.com/robherring/android_manifest -b master local_manifests
            cd ..
            repo sync -f --force-sync -j16

            mkdir -p out
            cp .repo/manifest.xml out/source-manifest.xml
            repo manifest -r -o out/pinned-manifest.xml

            # Temporary patches
            cd system/core
            git reset --hard aosp/master
            git clean -fdx
            git fetch https://github.com/robherring/system_core.git libsync && git merge FETCH_HEAD
            cd ../..

            cd frameworks/native
            git fetch https://android.googlesource.com/platform/frameworks/native refs/changes/01/147401/4 && git cherry-pick FETCH_HEAD
            cd ../..


            # configure the device
            cd device/linaro/generic
            make defconfig all
            cd ../../..

            source build/envsetup.sh

            LUNCH_TARGET="linaro_${ARCH}-userdebug"
            lunch ${LUNCH_TARGET}
            make -k -j8 systemimage ramdisk

            # Publish binaries
            wget https://git.linaro.org/ci/job/configs.git/blob_plain/HEAD:/android-lcr/generic/build-info/public-template.txt -O ${ANDROID_PRODUCT_OUT}/BUILD-INFO.txt

            PUB_DEST=/android/robher-aosp-gendev/${BUILD_NUMBER}/${LUNCH_TARGET}
            time linaro-cp.py \
              --api_version 3 \
              --manifest \
              --no-build-info \
              --split-job-owner \
              ${ANDROID_PRODUCT_OUT} \
              ${PUB_DEST} \
              --include "^[^/]+[._](img[^/]*|tar[^/]*|xml|sh|config)$" \
              --include "^[BHi][^/]+txt$" \
              --include "^(MANIFEST|MD5SUMS|changelog.txt)$"
    publishers:
        - logparser:
            parse-rules: '/var/lib/jenkins/userContent/android.parse'
            unstable-on-warning: false
            fail-on-error: false
        - email:
            recipients: 'rob.herring@linaro.org'
        - email-ext:
            recipients: 'rob.herring@linaro.org'
            content-type: text
            subject: 'errors for mesa master Android build ${BUILD_NUMBER}'
            body: |
                Build URL: ${PROJECT_URL}${BUILD_NUMBER}/
                Full log: ${PROJECT_URL}${BUILD_NUMBER}/consoleText
                Parsed warnings/errors: ${PROJECT_URL}${BUILD_NUMBER}/parsed_console

                ERRORS:
                ${BUILD_LOG_REGEX, regex="^.*? error: .*?$", linesBefore=0, linesAfter=2, showTruncatedLines=false}
            unstable: true
